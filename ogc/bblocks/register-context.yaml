transform:
  # Add @type from itemClass with initial capital letter
  - |
    .baseURL as $CS_URI |
    .bblocks |= map(
      ."@id" = "bblocks://\(.itemIdentifier)"
      | ."@type" = [("bblocks:" + (.itemClass[:1]|ascii_upcase) + .itemClass[1:]), "skos:Concept", "dcat:Dataset"]
      | ."skos:prefLabel" = .name
      | .ldContext |= if . then { "prof:hasArtifact": . , "prof:hasRole": "role:mapping", "dct:format": "application/ld+json", "dct:conformsTo": "https://www.w3.org/TR/json-ld11/" } else null end
      | .shaclShapes |= (if length > 0 then to_entries | map({ "prof:hasArtifact": .value, "rdfs:seeAlso": "bblocks://\(.key)", "prof:hasRole": "role:validation", "dct:format": "text/turtle", "dct:conformsTo": "shacl:" }) else null end)
      | .schema |= (if length > 0 then to_entries | map({ "prof:hasArtifact": .value , "prof:hasRole": "role:schema", "dct:format": .key, "dct:conformsTo": "https://json-schema.org/draft/2020-12/schema" }) else null end)
      | .openAPIDocument |= if . then { "prof:hasArtifact": . , "prof:hasRole": "role:schema", "dct:format": "application/yaml", "dct:conformsTo": "https://spec.openapis.org/oas/v3.1.0.html" } else null end
      | .ontology |= if . then { "prof:hasArtifact": . , "prof:hasRole": "role:specification", "dct:format": "text/turtle", "dct:conformsTo": "http://www.w3.org/2002/07/owl#Ontology" } else null end
      | .rdfData |= if length > 0 then map({ "prof:hasArtifact": . , "prof:hasRole": "role:data", "dct:format": "text/turtle" }) else [] end
      | .dependsOn |= if length > 0 then map("bblocks://\(.)") else null end
      | .profileOf |= if length > 0 then map("bblocks://\(.)") else null end
      | if $CS_URI then ."skos:topConceptOf" = {"@id": $CS_URI} end
    )
  # Add ConceptScheme
  - |
    if type == "array" then {
        "@id": "https://www.opengis.net/def/bblocks",
        "@type": ["skos:ConceptScheme", "dcat:Catalog"],
        "skos:prefLabel": "OGC Building Blocks Register",
        "hasConcepts": .
      } else . + {
        "@type": ["skos:ConceptScheme", "dcat:Catalog"],
        "name": "Building Blocks - \(.name)",
        "skos:prefLabel": "Building Blocks - \(.name)",
        "hasConcepts": .bblocks,
        "skos:hasTopConcept": (.bblocks | map({"@id": "bblocks://\(.itemIdentifier)"})) 
      } | del(.bblocks) end
  - '{ "@context": { "@base": ($baseUrl // "https://www.opengis.net/def/bblocks/") } } + .'

# TODO: add dateTimeSupersession, dateTimeRetirement, dateTimeInvalidation, predecessor, successor
context:
  '$':
    bblocks: https://www.opengis.net/def/bblocks/
    rdfs: http://www.w3.org/2000/01/rdf-schema#
    skos: http://www.w3.org/2004/02/skos/core#
    dct: http://purl.org/dc/terms/
    xsd: http://www.w3.org/2001/XMLSchema#
    prof: http://www.w3.org/ns/dx/prof/
    dcat: http://www.w3.org/ns/dcat#
    modspec: http://www.opengis.net/def/ont/modspec/
    void: http://rdfs.org/ns/void#
    foaf: http://xmlns.com/foaf/0.1/
    role: http://www.w3.org/ns/dx/prof/role/
    shacl: https://www.w3.org/TR/shacl/
    owl: http://www.w3.org/2002/07/owl#

    baseURL: '@id'
    name: rdfs:label
    abstract:
      '@id': dct:abstract
      '@type': https://www.w3.org/ns/iana/media-types/text/markdown
    description:
      '@id': dct:description
      '@type': https://www.w3.org/ns/iana/media-types/text/markdown
    # register:
    #  '@id': bblocks:inRegister
    #  '@type': '@id'
    #  '@context':
    #    '@base': http://www.opengis.net/def/bblocks/
    status:
      '@id': bblocks:status
      '@type': '@id'
      '@context':
        '@base': http://www.opengis.net/def/status/
    dateTimeAddition:
      '@id': dct:created
      '@type': xsd:dateTime
    version: dct:hasVersion
    dateOfLastChange:
      '@id': dct:modified
      '@type': xsd:date
    modified:
      '@id': dct:modified
      '@type': xsd:dateTime
    scope:
      '@id': bblocks:scope
      '@type': '@id'
      '@context':
        '@base': http://www.opengis.net/def/bblocks/scope/
    sources:
      '@id': dct:source
      '@context':
        title: rdfs:label
        link: '@id'
    schema:
      '@id': prof:hasResource
      '@type': '@id'
    ldContext:
      '@id': prof:hasResource
      '@type': '@id'
    sourceLdContext:
      '@id': bblocks:hasSourceJsonLdContext
      '@type': '@id'
    documentation:
      '@id': dct:description
      '@type': '@id'
      '@container': '@index'
      '@index': dct:identifier
      '@context':
        mediatype: dct:format
        url:
          '@id': rdfs:isDefinedBy
          '@type': '@id'
    rdfs:isDefinedBy:
      '@type': '@id'
    hasConcepts:
      '@reverse': skos:inScheme
    dependsOn:
      '@id': bblocks:dependsOn
      '@type': '@id'
    profileOf:
      '@id': prof:isProfileOf
      '@type': '@id'
    tags: dcat:keyword
    shaclShapes:
      '@id': prof:hasResource
      '@type': '@id'
    validationReport:
      '@id': bblocks:hasValidationReport
      '@type': '@id'
    validationPassed: bblocks:validationPassed
    imports:
      '@id': owl:imports
      '@type': '@id'
    conformanceClasses:
      '@id': modspec:class
      '@type': '@id'
    requirementClasses:
      '@id': modspec:requirementsClass
      '@type': '@id'
    sparqlEndpoint:
      '@id': void:sparqlEndpoint
      '@type': '@id'
    viewerURL:
      '@id': foaf:homepage
      '@type': '@id'
    dct:conformsTo:
      '@type': '@id'
    prof:hasRole:
      '@type': '@id'
    prof:hasArtifact:
      '@type': '@id'
    rdfs:seeAlso:
      '@type': '@id'
    ontology:
      '@id': prof:hasResource
      '@type': '@id'
    rdfData:
      '@id': prof:hasResource
      '@type': '@id'
